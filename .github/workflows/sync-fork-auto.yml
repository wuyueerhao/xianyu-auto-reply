name: ä¸€é”®è‡ªåŠ¨åŒæ­¥ Fork ä»“åº“ï¼ˆè‡ªåŠ¨æ£€æµ‹æºä»“åº“ + ä»£ç  + Tags + Releases + é™„ä»¶ï¼‰

on:
  workflow_dispatch:   # æ‰‹åŠ¨è§¦å‘ï¼Œæ¨è
  # schedule:
  #   - cron: '0 0 * * *'  # å¯é€‰ï¼šæ¯å¤©è‡ªåŠ¨åŒæ­¥

jobs:
  sync-fork:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # ----------------------------------------------
      # Step 1: è·å–å½“å‰ä»“åº“ä¿¡æ¯ï¼Œå¹¶æŸ¥è¯¢ä¸Šæ¸¸ï¼ˆæºï¼‰ä»“åº“
      # ----------------------------------------------
      - name: Get current repository info
        id: repo_info
        run: |
          echo "å½“å‰ä»“åº“: ${{ github.repository }}"
          echo "ä»“åº“æ‰€æœ‰è€…: ${{ github.repository_owner }}"
          echo "ä»“åº“åç§°: ${{ github.event.repository.name }}"

          REPO_INFO=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }})

          DEFAULT_BRANCH=$(echo "$REPO_INFO" | jq -r '.default_branch')
          IS_FORK=$(echo "$REPO_INFO" | jq -r '.fork')

          if [ "$IS_FORK" != "true" ]; then
            echo "âŒ å½“å‰ä»“åº“ä¸æ˜¯ Fork ä»“åº“ï¼Œæ— æ³•è‡ªåŠ¨æ£€æµ‹æºä»“åº“ã€‚"
            echo "âœ… è¯·ç¡®è®¤ä½ å·²æ‰‹åŠ¨ Fork äº†æŸä¸ªä¸Šæ¸¸ä»“åº“ã€‚"
            exit 1
          fi

          UPSTREAM_FULL_NAME=$(echo "$REPO_INFO" | jq -r '.parent.full_name')
          echo "æ£€æµ‹åˆ°æºä»“åº“ï¼ˆä¸Šæ¸¸ï¼‰: $UPSTREAM_FULL_NAME"
          echo "å½“å‰ä»“åº“é»˜è®¤åˆ†æ”¯: $DEFAULT_BRANCH"

          echo "upstream_full_name=$UPSTREAM_FULL_NAME" >> $GITHUB_OUTPUT
          echo "target_repo=${{ github.repository }}" >> $GITHUB_OUTPUT
          echo "default_branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT

      # ----------------------------------------------
      # Step 2: Checkout ä½ çš„ Fork ä»“åº“ï¼ˆä½¿ç”¨è‡ªåŠ¨æ£€æµ‹çš„é»˜è®¤åˆ†æ”¯ï¼‰
      # ----------------------------------------------
      - name: Checkout your fork (è‡ªåŠ¨åˆ†æ”¯)
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.repo_info.outputs.default_branch }}  # âœ… ä½¿ç”¨è‡ªåŠ¨æ£€æµ‹çš„åˆ†æ”¯
          token: ${{ secrets.MY_GIT_TOKEN }}
          fetch-depth: 0

      - name: Set Git Identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # ----------------------------------------------
      # Step 3: è·å–æºä»“åº“ä¿¡æ¯å¹¶è®¾ç½®è¿œç¨‹
      # ----------------------------------------------
      - name: Add upstream remote (æºä»“åº“)
        run: |
          UPSTREAM_REPO=${{ steps.repo_info.outputs.upstream_full_name }}
          echo "æ·»åŠ è¿œç¨‹æºä»“åº“: $UPSTREAM_REPO"

          # è·å–æºä»“åº“çš„é»˜è®¤åˆ†æ”¯
          UPSTREAM_INFO=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/$UPSTREAM_REPO)
          UPSTREAM_DEFAULT_BRANCH=$(echo "$UPSTREAM_INFO" | jq -r '.default_branch')
          echo "æºä»“åº“é»˜è®¤åˆ†æ”¯: $UPSTREAM_DEFAULT_BRANCH"

          git remote add upstream https://github.com/$UPSTREAM_REPO.git

          # å°†æºä»“åº“é»˜è®¤åˆ†æ”¯ä¹Ÿè¾“å‡ºä¸º GitHub Outputï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "upstream_default_branch=$UPSTREAM_DEFAULT_BRANCH" >> $GITHUB_OUTPUT

      - name: Fetch upstreamï¼ˆä»£ç  + Tagsï¼‰
        run: |
          UPSTREAM_DEFAULT_BRANCH=${{ steps.repo_info.outputs.upstream_default_branch }}
          echo "ğŸ” è·å–æºä»“åº“ä»£ç å’Œ Tagsï¼ˆåˆ†æ”¯: $UPSTREAM_DEFAULT_BRANCHï¼‰"
          git fetch upstream --tags

      - name: Push all tags to your fork
        run: |
          git push origin --tags

      - name: Merge upstream/{{ steps.repo_info.outputs.upstream_default_branch }}
        run: |
          UPSTREAM_DEFAULT_BRANCH=${{ steps.repo_info.outputs.upstream_default_branch }}
          echo "ğŸ”€ åˆå¹¶æºä»“åº“åˆ†æ”¯: upstream/$UPSTREAM_DEFAULT_BRANCH"
          git merge upstream/$UPSTREAM_DEFAULT_BRANCH --allow-unrelated-histories -X theirs || echo "Already up-to-date or no changes"

      - name: Push code to your fork (å½“å‰é»˜è®¤åˆ†æ”¯)
        run: |
          DEFAULT_BRANCH=${{ steps.repo_info.outputs.default_branch }}
          echo "ğŸ“¤ æ¨é€ä»£ç åˆ°ä½ çš„ forkï¼ˆåˆ†æ”¯: $DEFAULT_BRANCHï¼‰"
          git remote set-url origin https://${{ secrets.MY_GIT_TOKEN }}@github.com/${{ github.repository }}.git
          git push origin $DEFAULT_BRANCH
